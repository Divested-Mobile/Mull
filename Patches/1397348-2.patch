From 3ce20d76a6151683c26e04111d880fb58a9bd7cf Mon Sep 17 00:00:00 2001
From: Tad <tad@spotco.us>
Date: Mon, 18 Dec 2017 18:45:59 -0500
Subject: [PATCH] Bug 1419581 - Part 2: Guard PresentationMediaPlayer windows
 with MOZ_NATIVE_DEVICES.

---
 widget/android/nsWindow.cpp | 9 ++++++++-
 widget/android/nsWindow.h   | 2 ++
 2 files changed, 10 insertions(+), 1 deletion(-)

diff --git a/widget/android/nsWindow.cpp b/widget/android/nsWindow.cpp
index cf4617511110..879996d13706 100644
--- a/widget/android/nsWindow.cpp
+++ b/widget/android/nsWindow.cpp
@@ -1136,6 +1136,7 @@ public:
     }
 };
 
+#ifdef MOZ_NATIVE_DEVICES
 template<> const char
 nsWindow::NativePtr<nsWindow::LayerViewSupport>::sName[] = "LayerViewSupport";
 
@@ -1223,7 +1224,7 @@ public:
 
 ANativeWindow* nsWindow::PMPMSupport::sWindow;
 EGLSurface nsWindow::PMPMSupport::sSurface;
-
+#endif
 
 nsWindow::GeckoViewSupport::~GeckoViewSupport()
 {
@@ -1390,9 +1391,11 @@ nsWindow::InitNatives()
     nsWindow::GeckoViewSupport::Base::Init();
     nsWindow::LayerViewSupport::Init();
     nsWindow::NPZCSupport::Init();
+#ifdef MOZ_NATIVE_DEVICES
     if (jni::IsFennec()) {
         nsWindow::PMPMSupport::Init();
     }
+#endif
 
     GeckoEditableSupport::Init();
 }
@@ -2074,11 +2077,13 @@ nsWindow::GetNativeData(uint32_t aDataType)
             }
             return nullptr;
 
+#ifdef MOZ_NATIVE_DEVICES
         case NS_PRESENTATION_WINDOW:
             return PMPMSupport::sWindow;
 
         case NS_PRESENTATION_SURFACE:
             return PMPMSupport::sSurface;
+#endif
     }
 
     return nullptr;
@@ -2088,9 +2093,11 @@ void
 nsWindow::SetNativeData(uint32_t aDataType, uintptr_t aVal)
 {
     switch (aDataType) {
+#ifdef MOZ_NATIVE_DEVICES
         case NS_PRESENTATION_SURFACE:
             PMPMSupport::sSurface = reinterpret_cast<EGLSurface>(aVal);
             break;
+#endif
     }
 }
 
diff --git a/widget/android/nsWindow.h b/widget/android/nsWindow.h
index 0dc25d10b7bb..43b9e17ff553 100644
--- a/widget/android/nsWindow.h
+++ b/widget/android/nsWindow.h
@@ -193,8 +193,10 @@ private:
     // keep it last in the list, so its destructor is called first.
     mozilla::UniquePtr<GeckoViewSupport> mGeckoViewSupport;
 
+#ifdef MOZ_NATIVE_DEVICES
     // Class that implements native PresentationMediaPlayerManager calls.
     class PMPMSupport;
+#endif
 
     mozilla::Atomic<bool, mozilla::ReleaseAcquire> mContentDocumentDisplayed;
 
-- 
2.14.1

